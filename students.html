<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QÂ³ - Students</title>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
        }

        body {
            background-color: #ffffff;
            min-height: 100vh;
            display: flex;
            overflow-x: hidden;
        }

        /* Sidebar styles */
        .sidebar {
            width: 70px;
            background: #1e1e1e;
            height: 100vh;
            position: fixed;
            left: 0;
            top: 0;
            display: flex;
            flex-direction: column;
            transition: width 0.3s ease;
            z-index: 1000;
        }

        .sidebar:hover {
            width: 240px;
        }

        /* User Profile Section */
        .user-profile {
            height: 80px;
            width: 100%;
            display: flex;
            align-items: center;
            padding: 0 23px;
            margin-bottom: 20px;
        }

        .user-icon {
            width: 24px;
            height: 24px;
            min-width: 24px;
            background: #6200ee;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            color: white;
            transition: all 0.2s ease;
        }

        .sidebar:hover .user-icon {
            width: 40px;
            height: 40px;
            min-width: 40px;
            font-size: 16px;
        }

        .user-name {
            margin-left: 32px;
            font-size: 16px;
            color: rgba(255, 255, 255, 0.7);
            opacity: 0;
            transition: opacity 0.2s ease;
            white-space: nowrap;
        }

        .sidebar:hover .user-name {
            opacity: 1;
        }

        /* Navigation Section */
        .nav-items {
            display: flex;
            flex-direction: column;
            padding: 0;
            gap: 32px;
            margin-top: 20px;
        }

        .nav-item {
            height: 24px;
            display: flex;
            align-items: center;
            padding: 0 23px;
            color: rgba(255, 255, 255, 0.7);
            text-decoration: none;
            transition: color 0.2s ease;
        }

        .nav-item:hover {
            color: white;
        }

        .nav-item i {
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }

        .nav-item span {
            margin-left: 32px;
            font-size: 16px;
            opacity: 0;
            transition: opacity 0.2s ease;
            white-space: nowrap;
        }

        .sidebar:hover .nav-item span {
            opacity: 1;
        }

        /* Logo Section */
        .logo-container {
            margin-top: auto;
            height: 80px;
            width: 100%;
            display: flex;
            align-items: center;
            padding: 0 23px;
        }

        .logo {
            font-size: 28px;
            font-weight: bold;
            color: rgba(255, 255, 255, 0.7);
            text-decoration: none;
            transition: color 0.2s ease;
            letter-spacing: -1px;
        }

        .logo:hover {
            color: white;
        }

        /* Main Content */
        .main-content {
            margin-left: 70px;
            padding: 32px;
            width: calc(100% - 70px);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: stretch;
            justify-content: flex-start;
            transition: margin-left 0.3s ease, width 0.3s ease;
            padding-bottom: 120px;
            position: relative;
        }

        .sidebar:hover ~ .main-content {
            margin-left: 240px;
            width: calc(100% - 240px);
        }

        /* Page Title */
        .page-title {
            font-size: 20px;
            font-weight: 500;
            color: #333;
            margin-bottom: 32px;
            position: relative;
        }

        /* Empty State */
        .empty-state {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            margin: 0;
            padding: 32px;
            background: white;
        }

        .empty-state-text {
            color: #666;
            margin-bottom: 16px;
            font-size: 14px;
        }

        .empty-state .add-students-button {
            background: #6200ee;
            color: white;
            padding: 8px 16px;
            border-radius: 4px;
            text-decoration: none;
            font-size: 14px;
            font-weight: 500;
            border: none;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .empty-state .add-students-button:hover {
            background: #5000c9;
            transform: translateY(-1px);
        }

        .add-students-button {
            background: #6200ee;
            color: white;
            padding: 12px 24px;
            border-radius: 8px;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            font-size: 15px;
            transition: background-color 0.2s ease;
        }

        .add-students-button:hover {
            background: #5000c9;
        }

        /* Modal and Form Styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.4);
            justify-content: center;
            align-items: flex-start;
            z-index: 2000;
            backdrop-filter: blur(8px);
            padding: 20px;
            overflow-y: auto;
        }

        .modal-content {
            background: white;
            border-radius: 16px;
            padding: 32px;
            width: 100%;
            max-width: 520px;
            position: relative;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            margin: 40px auto;
            animation: modalSlideIn 0.3s ease forwards;
        }

        .modal form {
            max-height: calc(100vh - 200px);
            overflow-y: auto;
            padding-right: 16px;
            margin-right: -16px;
        }

        .modal form::-webkit-scrollbar {
            width: 8px;
        }

        .modal form::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }

        .modal form::-webkit-scrollbar-thumb {
            background: #ddd;
            border-radius: 4px;
        }

        .modal form::-webkit-scrollbar-thumb:hover {
            background: #ccc;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 32px;
            padding-bottom: 16px;
            border-bottom: 1px solid #f0f0f0;
        }

        .modal-header h2 {
            font-size: 24px;
            font-weight: 600;
            color: #1a1a1a;
            letter-spacing: -0.5px;
        }

        .close-button {
            background: none;
            border: none;
            color: #666;
            cursor: pointer;
            padding: 8px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .close-button:hover {
            background: #f5f5f5;
            color: #1a1a1a;
            transform: rotate(90deg);
        }

        .form-group {
            margin-bottom: 24px;
            position: relative;
            transition: all 0.2s ease;
        }

        .form-group:focus-within {
            transform: translateX(4px);
        }

        .form-group label {
            display: block;
            font-size: 14px;
            color: #666;
            margin-bottom: 8px;
            font-weight: 500;
            transition: color 0.2s ease;
        }

        .form-group:focus-within label {
            color: #6200ee;
        }

        .form-group input {
            width: 100%;
            padding: 14px 16px;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            font-size: 15px;
            color: #1a1a1a;
            background: #fff;
            transition: all 0.2s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.02);
        }

        .form-group input:hover {
            border-color: #d0d0d0;
            background: #fafafa;
        }

        .form-group input:focus {
            outline: none;
            border-color: #6200ee;
            background: #fff;
            box-shadow: 0 0 0 4px rgba(98, 0, 238, 0.1);
        }

        .form-group input::placeholder {
            color: #999;
            transition: opacity 0.2s ease;
        }

        .form-group input:focus::placeholder {
            opacity: 0.7;
        }

        .assignments-section,
        .homework-section {
            margin-top: 32px;
            padding: 24px;
            border: none;
            background: #f8f9fa;
            border-radius: 16px;
            position: relative;
            margin-bottom: 24px;
        }

        .assignments-section::before,
        .homework-section::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: #6200ee;
            border-radius: 4px 0 0 4px;
        }

        .assignments-section > label,
        .homework-section > label {
            display: block;
            font-size: 18px;
            font-weight: 600;
            color: #1a1a1a;
            margin-bottom: 20px;
            letter-spacing: -0.5px;
        }

        .submit-btn {
            position: sticky;
            bottom: 0;
            margin-top: 32px;
            background: #6200ee;
            color: white;
            width: 100%;
            padding: 16px;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            z-index: 10;
        }

        .submit-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .submit-btn.saving {
            background: #5000c9;
            pointer-events: none;
        }

        .submit-btn.saving::after {
            content: '';
            position: absolute;
            top: 50%;
            right: 16px;
            transform: translateY(-50%);
            width: 20px;
            height: 20px;
            border: 2px solid white;
            border-right-color: transparent;
            border-radius: 50%;
            animation: rotate 0.8s linear infinite;
        }

        @keyframes rotate {
            to {
                transform: translateY(-50%) rotate(360deg);
            }
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .modal {
                padding: 16px;
            }

            .modal-content {
                padding: 24px;
                margin: 20px auto;
            }

            .modal form {
                max-height: calc(100vh - 160px);
            }
        }

        @media (max-width: 480px) {
            .modal-content {
                padding: 20px;
                margin: 10px auto;
            }

            .modal form {
                max-height: calc(100vh - 120px);
            }
        }

        /* Input type number specific styles */
        .form-group input[type="number"] {
            -moz-appearance: textfield;
            appearance: textfield;
        }

        .form-group input[type="number"]::-webkit-outer-spin-button,
        .form-group input[type="number"]::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        /* Grade input specific styles */
        .grade-input-container {
            position: relative;
            display: flex;
            align-items: center;
        }

        .grade-input-container::after {
            content: '%';
            position: absolute;
            right: 16px;
            color: #666;
            font-size: 14px;
            pointer-events: none;
        }

        .grade-input-container input {
            padding-right: 32px;
        }

        /* Section transitions */
        .assignments-section,
        .homework-section {
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .assignments-section:hover,
        .homework-section:hover {
            transform: translateX(4px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        }

        /* Add these new styles */
        .student-header {
            width: 100%;
            margin-bottom: 32px;
        }

        .search-container {
            position: relative;
            width: 100%;
            max-width: 400px;
        }

        .search-input {
            width: 100%;
            padding: 12px 16px;
            border: none;
            border-radius: 8px;
            background: #f5f5f5;
            font-size: 14px;
            color: #333;
            transition: all 0.2s ease;
        }

        .search-input:focus {
            outline: none;
            background: #efefef;
        }

        .search-input::placeholder {
            color: #666;
        }

        .search-clear {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: #666;
            cursor: pointer;
            display: none;
        }

        .search-input:not(:placeholder-shown) + .search-clear {
            display: block;
        }

        .add-student-button {
            position: fixed;
            bottom: 32px;
            right: 32px;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: #6200ee;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            border: none;
            box-shadow: 0 4px 12px rgba(98, 0, 238, 0.24);
            transition: all 0.2s ease;
            z-index: 100;
        }

        .add-student-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(98, 0, 238, 0.32);
        }

        .add-student-button:active {
            transform: translateY(0);
            box-shadow: 0 4px 12px rgba(98, 0, 238, 0.24);
        }

        .add-student-button i {
            font-size: 24px;
        }

        .students-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            margin-top: 0;
        }

        .students-table th {
            text-align: left;
            padding: 12px 16px;
            color: #333;
            font-weight: 500;
            border-bottom: 1px solid #eee;
            background: white;
        }

        .students-table td {
            padding: 16px;
            color: #333;
            border-bottom: 1px solid #eee;
            vertical-align: middle;
        }

        .student-row {
            transition: background-color 0.2s ease;
        }

        .student-row:hover {
            background-color: #f9f9f9;
        }

        .student-name {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .student-avatar {
            width: 32px;
            height: 32px;
            background: #455A64;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 14px;
        }

        .student-info {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .student-info .name {
            font-weight: 500;
            color: #333;
            font-size: 14px;
        }

        .student-info .pronouns {
            font-size: 13px;
            color: #666;
        }

        .grade {
            font-weight: 500;
            font-size: 14px;
        }

        .caption {
            font-size: 12px;
            color: #666;
            margin-bottom: 4px;
        }

        .report-button {
            background: #e8fff1;
            color: #00875a;
            padding: 8px 16px;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.2s ease;
            font-weight: 500;
        }

        .report-button:hover {
            background: #d1ffe3;
        }

        .access-toggle {
            position: relative;
            display: inline-block;
            width: 36px;
            height: 20px;
            vertical-align: middle;
        }

        .access-toggle input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #eee;
            transition: .4s;
            border-radius: 20px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 2px;
            bottom: 2px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        .access-toggle input:checked + .toggle-slider {
            background-color: #6200ee;
        }

        .access-toggle input:checked + .toggle-slider:before {
            transform: translateX(16px);
        }

        .access-status {
            font-size: 13px;
            color: #ff4444;
            margin-left: 8px;
            vertical-align: middle;
        }

        .access-status.active {
            color: #333;
        }

        .student-actions {
            display: flex;
            gap: 4px;
        }

        .action-button {
            width: 32px;
            height: 32px;
            border-radius: 4px;
            border: none;
            background: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #666;
            transition: all 0.2s ease;
        }

        .action-button:hover {
            background: #f5f5f5;
            color: #333;
        }

        .action-button i {
            font-size: 18px;
        }

        .pagination {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-top: 16px;
            padding: 16px 0;
            border-top: 1px solid #eee;
            background: white;
            position: relative;
            z-index: 99;
        }

        .pagination-info {
            color: #666;
            font-size: 13px;
        }

        .pagination-controls {
            display: flex;
            gap: 4px;
            margin-right: 80px;
        }

        .pagination-button {
            width: 32px;
            height: 32px;
            border: 1px solid #e0e0e0;
            border-radius: 4px;
            background: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #333;
            transition: all 0.2s ease;
        }

        .pagination-button:hover:not(:disabled) {
            background: #f5f5f5;
            border-color: #d0d0d0;
        }

        .pagination-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            border-color: #e0e0e0;
        }

        .pagination-button i {
            font-size: 20px;
        }

        /* Update modal styles */
        .modal-tabs {
            display: flex;
            gap: 32px;
            margin-bottom: 24px;
        }

        .modal-tab {
            font-size: 14px;
            color: #666;
            cursor: pointer;
            transition: all 0.2s ease;
            padding-bottom: 8px;
            position: relative;
        }

        .modal-tab.active {
            color: #6200ee;
        }

        .modal-tab.active::after {
            content: '';
            position: absolute;
            bottom: -1px;
            left: 0;
            width: 100%;
            height: 2px;
            background: #6200ee;
            border-radius: 2px;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .form-row {
            display: flex;
            gap: 16px;
            margin-bottom: 20px;
        }

        .form-field {
            margin-bottom: 16px;
        }

        .form-field label {
            display: block;
            font-size: 12px;
            color: #333;
            margin-bottom: 8px;
            font-weight: 500;
        }

        .form-field input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            background: #f8f9fa;
            transition: all 0.2s ease;
        }

        .form-field input:focus {
            outline: none;
            border-color: #6200ee;
            background: white;
            box-shadow: 0 0 0 4px rgba(98, 0, 238, 0.1);
        }

        .form-field input::placeholder {
            color: #999;
        }

        .sidebar:hover ~ .main-content .add-student-button {
            right: calc(32px + 170px);
            transition: right 0.3s ease;
        }

        .delete-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            justify-content: center;
            align-items: center;
            z-index: 2500;
            backdrop-filter: blur(2px);
        }

        .delete-modal-content {
            background: white;
            border-radius: 12px;
            padding: 32px;
            width: 90%;
            max-width: 460px;
            text-align: center;
        }

        .delete-modal-title {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 12px;
            color: #333;
        }

        .delete-modal-text {
            font-size: 16px;
            color: #333;
            margin-bottom: 24px;
        }

        .delete-warning {
            background: rgba(255, 68, 68, 0.1);
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 32px;
            display: flex;
            align-items: flex-start;
            gap: 12px;
        }

        .delete-warning i {
            color: #ff4444;
            font-size: 24px !important;
        }

        .delete-warning-text {
            color: #d14343;
            font-size: 14px;
            text-align: left;
            line-height: 1.5;
        }

        .delete-modal-buttons {
            display: flex;
            gap: 16px;
            justify-content: center;
        }

        .delete-modal-button {
            padding: 12px 24px;
            border-radius: 6px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.2s ease;
            border: none;
        }

        .delete-modal-button.cancel {
            background: #333;
            color: white;
        }

        .delete-modal-button.cancel:hover {
            background: #444;
        }

        .delete-modal-button.confirm {
            background: white;
            color: #ff4444;
            border: 2px solid #ff4444;
        }

        .delete-modal-button.confirm:hover {
            background: #ff4444;
            color: white;
        }

        /* Add these styles for the submit button states */
        .submit-btn.success {
            background: #00c853;
            pointer-events: none;
        }

        .submit-btn.error {
            background: #ff1744;
            pointer-events: none;
        }

        .submit-btn.saving {
            background: #5000c9;
            pointer-events: none;
        }

        /* Report Modal Styles */
        .report-content {
            max-height: 70vh;
            overflow-y: auto;
            padding-right: 16px;
        }
        
        .student-report-header {
            display: flex;
            align-items: center;
            gap: 16px;
            margin-bottom: 24px;
            padding-bottom: 16px;
            border-bottom: 1px solid #eee;
        }
        
        .student-avatar.large {
            width: 64px;
            height: 64px;
            font-size: 24px;
            background: #455A64;
        }
        
        .student-report-info h3 {
            font-size: 20px;
            margin: 0 0 4px 0;
        }
        
        .student-report-info p {
            margin: 0 0 8px 0;
            color: #666;
        }
        
        .status-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
            background: #ffdddd;
            color: #cc0000;
        }
        
        .status-badge.active {
            background: #e8f5e9;
            color: #1b5e20;
        }
        
        .report-section {
            margin-bottom: 24px;
            padding: 16px;
            background: #f9f9f9;
            border-radius: 8px;
        }
        
        .report-section h4 {
            margin: 0 0 16px 0;
            font-size: 16px;
            color: #333;
        }
        
        .grades-overview {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 16px;
        }
        
        .grade-item {
            background: white;
            padding: 16px;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        
        .grade-item.total {
            grid-column: 1 / -1;
            background: #e8f5e9;
        }
        
        .grade-label {
            font-size: 13px;
            color: #666;
            margin-bottom: 8px;
        }
        
        .grade-value {
            font-size: 24px;
            font-weight: 600;
            color: #333;
        }
        
        .grades-detail {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .grade-row {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .grade-name {
            width: 120px;
            font-size: 14px;
        }
        
        .grade-bar-container {
            flex: 1;
            height: 12px;
            background: #eeeeee;
            border-radius: 6px;
            overflow: hidden;
        }
        
        .grade-bar {
            height: 100%;
            background: #6200ee;
            border-radius: 6px;
            transition: width 0.5s ease;
        }
        
        .grade-number {
            width: 40px;
            text-align: right;
            font-weight: 500;
            font-size: 14px;
        }
        
        .comments-container {
            max-height: 200px;
            overflow-y: auto;
        }
        
        .comment-item {
            padding: 12px;
            background: white;
            border-radius: 8px;
            margin-bottom: 8px;
        }
        
        .ai-summary {
            background: #ede7f6;
        }
        
        .ai-summary-content {
            background: white;
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 16px;
        }
        
        .ai-summary-content p {
            margin: 0 0 12px 0;
            line-height: 1.5;
        }
        
        #commentInput {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            resize: vertical;
            min-height: 80px;
            margin-bottom: 12px;
            font-family: inherit;
        }
        
        .add-comment-btn {
            background: #6200ee;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            font-weight: 500;
            cursor: pointer;
            transition: background 0.2s ease;
        }
        
        .add-comment-btn:hover {
            background: #5000c9;
        }

        .ai-summary-loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
            text-align: center;
        }
        
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-radius: 50%;
            border-top: 4px solid #6200ee;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin-bottom: 16px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .ai-summary-error {
            padding: 16px;
            background-color: #ffebee;
            border-radius: 8px;
            color: #c62828;
        }
        
        .error-details {
            font-size: 12px;
            opacity: 0.8;
        }

        .ai-summary-placeholder {
            text-align: center;
            padding: 24px;
            background: white;
            border-radius: 8px;
        }
        
        .generate-ai-btn {
            background: #6200ee;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            margin-top: 16px;
        }
        
        .generate-ai-btn:hover {
            background: #5000c9;
            transform: translateY(-1px);
        }
        
        .generate-ai-btn:active {
            transform: translateY(0);
        }
    </style>
</head>
<body>
    <div class="sidebar">
        <div class="user-profile">
            <div class="user-icon">P</div>
            <div class="user-name">Professor Sam</div>
        </div>
        <nav class="nav-items">
            <a href="home.html" class="nav-item">
                <i class="material-icons-round">home</i>
                <span>Home</span>
            </a>
            <a href="#" class="nav-item">
                <i class="material-icons-round">settings</i>
                <span>Settings</span>
            </a>
            <a href="#" class="nav-item" onclick="handleLogout()">
                <i class="material-icons-round">logout</i>
                <span>Log out</span>
            </a>
        </nav>
        <div class="logo-container">
            <a href="#" class="logo">QÂ³</a>
        </div>
    </div>

    <div class="main-content">
        <h1 class="page-title">Students</h1>
        
        <div class="student-header">
            <div class="search-container">
                <input type="text" class="search-input" placeholder="student name" id="searchInput">
            </div>
        </div>

        <div id="emptyState" class="empty-state">
            <p class="empty-state-text">there are currently no students in the course</p>
            <button class="add-students-button" onclick="showModal(event)">
                add students
            </button>
        </div>

        <button class="add-student-button" onclick="showModal(event)">
            <i class="material-icons-round">add</i>
        </button>

        <div id="studentsList" style="display: none;">
            <table class="students-table">
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Total Grade</th>
                        <th>Report</th>
                        <th>Course Access</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody id="studentsTableBody">
                    <!-- Students will be added here dynamically -->
                </tbody>
            </table>

            <div class="pagination">
                <span class="pagination-info">1-10 of 100</span>
                <div class="pagination-controls">
                    <button class="pagination-button" disabled>
                        <i class="material-icons-round">first_page</i>
                    </button>
                    <button class="pagination-button" disabled>
                        <i class="material-icons-round">chevron_left</i>
                    </button>
                    <button class="pagination-button">
                        <i class="material-icons-round">chevron_right</i>
                    </button>
                    <button class="pagination-button">
                        <i class="material-icons-round">last_page</i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Update Modal -->
    <div class="modal" id="addStudentModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Add Student</h2>
                <button type="button" class="close-button" onclick="hideModal()">
                    <i class="material-icons-round">close</i>
                </button>
            </div>
            <form id="addStudentForm" onsubmit="handleAddStudent(event)">
                <div class="form-group">
                    <label for="firstName">First Name</label>
                    <input type="text" id="firstName" name="firstName" placeholder="Enter first name" required>
                </div>
                <div class="form-group">
                    <label for="lastName">Last Name</label>
                    <input type="text" id="lastName" name="lastName" placeholder="Enter last name" required>
                </div>
                <div class="form-group">
                    <label for="email">Email</label>
                    <input type="email" id="email" name="email" placeholder="Enter email address" required>
                </div>
                <button type="submit" class="submit-btn">Add Student</button>
            </form>
        </div>
    </div>

    <script src="auth.js"></script>
    <script>
        // Protect this route
        protectRoute();

        // Initialize variables
        const courseId = new URLSearchParams(window.location.search).get('courseId');
        let currentCourse = auth.getUserCourses().find(c => c.id === parseInt(courseId));
        
        if (!currentCourse) {
            window.location.href = 'home.html';
        }

        let students = currentCourse.students;
        let originalStudents = [...students];
        let currentPage = 1;
        const ITEMS_PER_PAGE = 10;

        // Update user name in sidebar
        const currentUser = auth.getCurrentUser();
        document.querySelector('.user-name').textContent = currentUser.name;
        document.querySelector('.user-icon').textContent = currentUser.name.charAt(0);

        function handleLogout() {
            auth.logout();
        }

        function handleAddStudent(event) {
            event.preventDefault();
            const firstName = document.getElementById('firstName').value;
            const lastName = document.getElementById('lastName').value;
            const email = document.getElementById('email').value;

            const newStudent = {
                id: Date.now(),
                firstName,
                lastName,
                email,
                active: true,
                grades: {
                    midterm: 0,
                    final: 0,
                    assignments: []
                }
            };

            const courses = auth.getUserCourses();
            currentCourse = courses.find(c => c.id === parseInt(courseId));
            
            if (!currentCourse) {
                window.location.href = 'home.html';
                return;
            }

            currentCourse.students.push(newStudent);
            auth.updateCourse(currentCourse.id, currentCourse);
            
            students = currentCourse.students;
            originalStudents = [...students];
            
            updateDisplay();
            hideModal();
            document.getElementById('addStudentForm').reset();
        }

        function showModal(event) {
            event.preventDefault();
            document.getElementById('addStudentModal').style.display = 'flex';
            // Reset form
            const form = document.getElementById('addStudentForm');
            if (form) {
                form.reset();
            }
        }

        function hideModal() {
            const modal = document.getElementById('addStudentModal');
            if (modal) {
                modal.style.display = 'none';
                const form = document.getElementById('addStudentForm');
                if (form) {
                    form.reset();
                }
            }
        }

        function updateDisplay() {
            const emptyState = document.getElementById('emptyState');
            const studentsList = document.getElementById('studentsList');
            const floatingAddButton = document.querySelector('.add-student-button');
            const paginationInfo = document.querySelector('.pagination-info');
            
            // Only update students from currentCourse if we're not in the middle of a search
            const searchTerm = document.getElementById('searchInput').value.trim();
            if (!searchTerm) {
                initializeStudentData();
            }
            
            floatingAddButton.style.display = students.length > 0 ? 'flex' : 'none';
            
            if (students.length > 0) {
                emptyState.style.display = 'none';
                studentsList.style.display = 'block';

                const startIndex = (currentPage - 1) * ITEMS_PER_PAGE;
                const endIndex = Math.min(startIndex + ITEMS_PER_PAGE, students.length);
                const totalPages = Math.ceil(students.length / ITEMS_PER_PAGE);

                // Update pagination info
                if (paginationInfo) {
                    paginationInfo.textContent = `${startIndex + 1}-${endIndex} of ${students.length}`;
                }

                // Update pagination buttons
                updatePaginationButtons(totalPages);
                
                // Display current students
                displayStudents(startIndex, endIndex);
            } else {
                emptyState.style.display = 'flex';
                studentsList.style.display = 'none';
            }
        }

        function updatePaginationButtons(totalPages) {
            const prevButton = document.querySelector('.pagination-button:nth-child(2)');
            const nextButton = document.querySelector('.pagination-button:nth-child(3)');
            const firstButton = document.querySelector('.pagination-button:nth-child(1)');
            const lastButton = document.querySelector('.pagination-button:nth-child(4)');
            
            if (prevButton && nextButton && firstButton && lastButton) {
                prevButton.disabled = currentPage === 1;
                nextButton.disabled = currentPage === totalPages;
                firstButton.disabled = currentPage === 1;
                lastButton.disabled = currentPage === totalPages;
            }
        }

        function displayStudents(startIndex, endIndex) {
            const tbody = document.getElementById('studentsTableBody');
            const currentStudents = students.slice(startIndex, endIndex);
            
            tbody.innerHTML = '';
            
            currentStudents.forEach(student => {
                // Ensure student has first and last names with fallback
                const firstName = student.firstName || '';
                const lastName = student.lastName || '';
                const initials = (firstName ? firstName[0] : '') + (lastName ? lastName[0] : '');
                
                const row = document.createElement('tr');
                row.className = 'student-row';
                row.innerHTML = `
                    <td>
                        <div class="student-name">
                            <div class="student-avatar">${initials}</div>
                            <div class="student-info">
                                <div class="name">${firstName} ${lastName}</div>
                                <div class="pronouns">${student.email || ''}</div>
                            </div>
                        </div>
                    </td>
                    <td class="grade">${student.grade || 0}</td>
                    <td>
                        <button class="report-button">Get Report</button>
                    </td>
                    <td>
                        <label class="access-toggle">
                            <input type="checkbox" ${student.active ? 'checked' : ''}>
                            <span class="toggle-slider"></span>
                        </label>
                        <span class="access-status ${student.active ? 'active' : ''}">
                            ${student.active ? 'Active' : 'Inactive'}
                        </span>
                    </td>
                    <td>
                        <div class="student-actions">
                            <button type="button" class="action-button edit-button">
                                <i class="material-icons-round">edit</i>
                            </button>
                            <button type="button" class="action-button delete-button">
                                <i class="material-icons-round">delete</i>
                            </button>
                        </div>
                    </td>
                `;
                
                const toggleInput = row.querySelector('input[type="checkbox"]');
                if (toggleInput) {
                    toggleInput.addEventListener('change', () => toggleAccess(student.id));
                }
                
                const editButton = row.querySelector('.edit-button');
                if (editButton) {
                    editButton.addEventListener('click', () => editStudent(student.id));
                }
                
                const deleteButton = row.querySelector('.delete-button');
                if (deleteButton) {
                    deleteButton.addEventListener('click', () => deleteStudent(student.id));
                }
                
                const reportButton = row.querySelector('.report-button');
                if (reportButton) {
                    reportButton.addEventListener('click', () => generateStudentReport(student.id));
                }
                
                tbody.appendChild(row);
            });
        }

        function toggleAccess(studentId) {
            try {
                // Get fresh course data
                const urlParams = new URLSearchParams(window.location.search);
                const courseId = urlParams.get('courseId');
                
                if (!courseId) {
                    console.error('Course ID not found');
                    return;
                }
                
                const courses = auth.getUserCourses();
                const course = courses.find(c => c.id === parseInt(courseId));
                
                if (!course) {
                    console.error('Course not found');
                    return;
                }

                // Update currentCourse reference
                currentCourse = course;

                // Find student using string comparison for consistency
                const student = currentCourse.students.find(s => String(s.id) === String(studentId));
                if (!student) {
                    console.error('Student not found');
                    return;
                }

                student.active = !student.active;
                auth.updateCourse(currentCourse.id, currentCourse);
                
                // Update local data
                students = currentCourse.students;
                originalStudents = [...students];
                
                updateDisplay();
            } catch (error) {
                console.error('Error toggling access:', error);
                alert('Failed to toggle student access. Please try again.');
            }
        }

        function editStudent(studentId) {
            try {
                // Get courseId from URL
                const urlParams = new URLSearchParams(window.location.search);
                const courseId = urlParams.get('courseId');
                
                if (!courseId) {
                    console.error('Course ID not found');
                    return;
                }
                
                // Get fresh course data
                const courses = auth.getUserCourses();
                const course = courses.find(c => c.id === parseInt(courseId));
                
                if (!course) {
                    console.error('Course not found');
                    return;
                }

                // Update currentCourse reference
                currentCourse = course;
                
                const student = currentCourse.students.find(s => String(s.id) === String(studentId));
                if (!student) {
                    console.error('Student not found');
                    return;
                }

                // Remove existing modal if any
                const existingModal = document.getElementById('editStudentModal');
                if (existingModal) {
                    existingModal.remove();
                }

                const editModal = document.createElement('div');
                editModal.className = 'modal';
                editModal.id = 'editStudentModal';
                editModal.style.display = 'flex';
                editModal.innerHTML = `
                    <div class="modal-content">
                        <div class="modal-header">
                            <h2>Edit Student</h2>
                            <button type="button" class="close-button" onclick="cancelEditStudent()">
                                <i class="material-icons-round">close</i>
                            </button>
                        </div>
                        <form id="editStudentForm">
                            <div class="form-group">
                                <label for="editFirstName">First Name</label>
                                <input type="text" id="editFirstName" value="${student.firstName || ''}" required>
                            </div>
                            <div class="form-group">
                                <label for="editLastName">Last Name</label>
                                <input type="text" id="editLastName" value="${student.lastName || ''}" required>
                            </div>
                            <div class="form-group">
                                <label for="editEmail">Email</label>
                                <input type="email" id="editEmail" value="${student.email || ''}" required>
                            </div>
                            <div class="form-group">
                                <label for="editMidterm">Midterm Grade</label>
                                <div class="grade-input-container">
                                    <input type="number" id="editMidterm" value="${student.grades?.midterm || 0}" min="0" max="100" required>
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="editFinal">Final Grade</label>
                                <div class="grade-input-container">
                                    <input type="number" id="editFinal" value="${student.grades?.final || 0}" min="0" max="100" required>
                                </div>
                            </div>
                            <div class="assignments-section">
                                <label>Assignments</label>
                                <div class="form-group">
                                    <label for="editAssignment1">Assignment 1</label>
                                    <div class="grade-input-container">
                                        <input type="number" id="editAssignment1" value="${student.grades?.assignments[0]?.grade || 0}" min="0" max="100">
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label for="editAssignment2">Assignment 2</label>
                                    <div class="grade-input-container">
                                        <input type="number" id="editAssignment2" value="${student.grades?.assignments[1]?.grade || 0}" min="0" max="100">
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label for="editAssignment3">Assignment 3</label>
                                    <div class="grade-input-container">
                                        <input type="number" id="editAssignment3" value="${student.grades?.assignments[2]?.grade || 0}" min="0" max="100">
                                    </div>
                                </div>
                            </div>
                            <div class="homework-section">
                                <label>Homework</label>
                                <div class="form-group">
                                    <label for="editHW1">HW1</label>
                                    <div class="grade-input-container">
                                        <input type="number" id="editHW1" value="${student.grades?.assignments[3]?.grade || 0}" min="0" max="100">
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label for="editHW2">HW2</label>
                                    <div class="grade-input-container">
                                        <input type="number" id="editHW2" value="${student.grades?.assignments[4]?.grade || 0}" min="0" max="100">
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label for="editHW3">HW3</label>
                                    <div class="grade-input-container">
                                        <input type="number" id="editHW3" value="${student.grades?.assignments[5]?.grade || 0}" min="0" max="100">
                                    </div>
                                </div>
                            </div>
                            <button type="submit" class="submit-btn">Save Changes</button>
                        </form>
                    </div>
                `;
                
                document.body.appendChild(editModal);

                // Add submit event listener to the form
                const form = editModal.querySelector('#editStudentForm');
                form.addEventListener('submit', (event) => handleEditStudent(event, studentId));
            } catch (error) {
                console.error('Error opening edit modal:', error);
                alert('Failed to open edit student form. Please try again.');
            }
        }

        function handleEditStudent(event, studentId) {
            event.preventDefault();
            
            const submitBtn = event.target.querySelector('.submit-btn');
            submitBtn.disabled = true;
            submitBtn.classList.add('saving');
            submitBtn.textContent = 'Saving...';

            try {
                // Get courseId from URL
                const urlParams = new URLSearchParams(window.location.search);
                const courseId = urlParams.get('courseId');
                
                if (!courseId) {
                    throw new Error('Course ID not found');
                }
                
                // Get fresh course data
                const courses = auth.getUserCourses();
                const course = courses.find(c => c.id === parseInt(courseId));
                
                if (!course) {
                    throw new Error('Course not found');
                }

                // Update currentCourse reference
                currentCourse = course;
                
                // Find student in currentCourse.students - compare as strings to ensure type consistency
                const student = currentCourse.students.find(s => String(s.id) === String(studentId));
                if (!student) {
                    throw new Error('Student not found');
                }

                // Update student info
                student.firstName = document.getElementById('editFirstName').value.trim();
                student.lastName = document.getElementById('editLastName').value.trim();
                student.email = document.getElementById('editEmail').value.trim();

                // Initialize or update grades
                if (!student.grades) {
                    student.grades = {
                        midterm: 0,
                        final: 0,
                        assignments: []
                    };
                }

                // Update grades
                student.grades.midterm = Math.min(100, Math.max(0, parseFloat(document.getElementById('editMidterm').value) || 0));
                student.grades.final = Math.min(100, Math.max(0, parseFloat(document.getElementById('editFinal').value) || 0));

                // Update assignments and homework
                student.grades.assignments = [
                    { name: 'Assignment 1', grade: Math.min(100, Math.max(0, parseFloat(document.getElementById('editAssignment1').value) || 0)) },
                    { name: 'Assignment 2', grade: Math.min(100, Math.max(0, parseFloat(document.getElementById('editAssignment2').value) || 0)) },
                    { name: 'Assignment 3', grade: Math.min(100, Math.max(0, parseFloat(document.getElementById('editAssignment3').value) || 0)) },
                    { name: 'HW1', grade: Math.min(100, Math.max(0, parseFloat(document.getElementById('editHW1').value) || 0)) },
                    { name: 'HW2', grade: Math.min(100, Math.max(0, parseFloat(document.getElementById('editHW2').value) || 0)) },
                    { name: 'HW3', grade: Math.min(100, Math.max(0, parseFloat(document.getElementById('editHW3').value) || 0)) }
                ];

                // Calculate total grade
                const midtermWeight = 0.25;
                const finalWeight = 0.35;
                const assignmentWeight = 0.25;
                const homeworkWeight = 0.15;

                const assignmentGrades = student.grades.assignments.slice(0, 3).map(a => a.grade);
                const homeworkGrades = student.grades.assignments.slice(3, 6).map(a => a.grade);

                const totalGrade = (
                    student.grades.midterm * midtermWeight +
                    student.grades.final * finalWeight +
                    (assignmentGrades.reduce((a, b) => a + b, 0) / 3) * assignmentWeight +
                    (homeworkGrades.reduce((a, b) => a + b, 0) / 3) * homeworkWeight
                );

                student.grade = Math.round(totalGrade);

                // Update in auth
                auth.updateCourse(currentCourse.id, currentCourse);

                // Get fresh data to ensure we have the latest
                const updatedCourses = auth.getUserCourses();
                const updatedCourse = updatedCourses.find(c => c.id === parseInt(courseId));
                
                if (updatedCourse) {
                    currentCourse = updatedCourse;
                    students = currentCourse.students;
                    originalStudents = [...students];
                }

                // Update display
                updateDisplay();

                // Show success state
                submitBtn.textContent = 'Saved!';
                submitBtn.classList.remove('saving');
                submitBtn.classList.add('success');

                // Close modal after success
                setTimeout(() => {
                    const modal = document.getElementById('editStudentModal');
                    if (modal) {
                        modal.remove();
                    }
                }, 1000);

            } catch (error) {
                console.error('Error saving student:', error);
                submitBtn.textContent = error.message || 'Error Saving';
                submitBtn.classList.remove('saving');
                submitBtn.classList.add('error');

                setTimeout(() => {
                    submitBtn.textContent = 'Save Changes';
                    submitBtn.classList.remove('error');
                    submitBtn.disabled = false;
                }, 3000);
            }
        }

        function deleteStudent(studentId) {
            try {
                // Get fresh course data
                const urlParams = new URLSearchParams(window.location.search);
                const courseId = urlParams.get('courseId');
                
                if (!courseId) {
                    console.error('Course ID not found');
                    return;
                }
                
                const courses = auth.getUserCourses();
                const course = courses.find(c => c.id === parseInt(courseId));
                
                if (!course) {
                    console.error('Course not found');
                    return;
                }

                // Update currentCourse reference
                currentCourse = course;
                
                const student = currentCourse.students.find(s => String(s.id) === String(studentId));
                if (!student) {
                    console.error('Student not found');
                    return;
                }

                // Remove existing modal if any
                const existingModal = document.getElementById('deleteModal');
                if (existingModal) {
                    existingModal.remove();
                }

                const deleteModal = document.createElement('div');
                deleteModal.className = 'delete-modal';
                deleteModal.id = 'deleteModal';
                deleteModal.style.display = 'flex';
                deleteModal.innerHTML = `
                    <div class="delete-modal-content">
                        <h2 class="delete-modal-title">Delete Student</h2>
                        <p class="delete-modal-text">Are you sure you want to delete <strong>${student.firstName} ${student.lastName}</strong>?</p>
                        <div class="delete-warning">
                            <i class="material-icons-round">warning</i>
                            <div class="delete-warning-text">
                                This action cannot be undone. The student's data, including all grades and records, will be permanently deleted.
                            </div>
                        </div>
                        <div class="delete-modal-buttons">
                            <button type="button" class="delete-modal-button cancel" onclick="cancelDelete()">No, Cancel</button>
                            <button type="button" class="delete-modal-button confirm" onclick="confirmDeleteStudent('${studentId}')">Yes, Delete</button>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(deleteModal);
            } catch (error) {
                console.error('Error opening delete modal:', error);
                alert('Failed to open delete confirmation. Please try again.');
            }
        }

        function confirmDeleteStudent(studentId) {
            try {
                // Convert studentId to string to match what's in the array
                studentId = String(studentId);
                
                // Get the course ID from URL
                const urlParams = new URLSearchParams(window.location.search);
                const courseId = urlParams.get('courseId');
                
                if (!courseId) {
                    throw new Error('Course ID not found');
                }
                
                // Get fresh course data directly from localStorage
                const users = JSON.parse(localStorage.getItem('q3_users'));
                const currentUser = auth.getCurrentUser();
                
                if (!currentUser) {
                    throw new Error('User not logged in');
                }
                
                const userIndex = users.findIndex(u => u.id === currentUser.id);
                
                if (userIndex === -1) {
                    throw new Error('User not found');
                }
                
                // Find the course in the user's courses
                const courseIndex = users[userIndex].courses.findIndex(c => c.id === parseInt(courseId));
                
                if (courseIndex === -1) {
                    throw new Error('Course not found');
                }
                
                // Get the current course
                const course = users[userIndex].courses[courseIndex];
                
                // Find the student in the course - convert both to string for comparison
                const studentIndex = course.students.findIndex(s => String(s.id) === studentId);
                
                if (studentIndex === -1) {
                    throw new Error('Student not found');
                }
                
                // Remove the student from the course
                course.students.splice(studentIndex, 1);
                
                // Update the course in the user's courses
                users[userIndex].courses[courseIndex] = course;
                
                // Save the updated users to localStorage
                localStorage.setItem('q3_users', JSON.stringify(users));
                
                // Update local variables
                currentCourse = course;
                students = currentCourse.students;
                originalStudents = [...students];
                
                // Update pagination if needed
                if (students.length === 0) {
                    currentPage = 1;
                } else if (students.length <= (currentPage - 1) * ITEMS_PER_PAGE) {
                    currentPage--;
                }
                
                // Remove modal
                const modal = document.getElementById('deleteModal');
                if (modal) {
                    modal.remove();
                }
                
                // Update display
                updateDisplay();
                
            } catch (error) {
                console.error('Error deleting student:', error);
                alert('Failed to delete student: ' + error.message);
            }
        }

        function cancelDelete() {
            const modal = document.getElementById('deleteModal');
            if (modal) {
                modal.remove();
            }
        }

        function cancelEditStudent() {
            const modal = document.getElementById('editStudentModal');
            if (modal) {
                modal.remove();
            }
        }

        function clearSearch() {
            document.getElementById('searchInput').value = '';
            document.querySelector('.search-clear').style.display = 'none';
        }

        // Pagination functions
        function goToFirstPage() {
            currentPage = 1;
            updateDisplay();
        }

        function goToPrevPage() {
            if (currentPage > 1) {
                currentPage--;
                updateDisplay();
            }
        }

        function goToNextPage() {
            const totalPages = Math.ceil(students.length / ITEMS_PER_PAGE);
            if (currentPage < totalPages) {
                currentPage++;
                updateDisplay();
            }
        }

        function goToLastPage() {
            currentPage = Math.ceil(students.length / ITEMS_PER_PAGE);
            updateDisplay();
        }

        // Initialize pagination button event listeners
        document.querySelectorAll('.pagination-button').forEach((button, index) => {
            button.addEventListener('click', () => {
                switch(index) {
                    case 0: goToFirstPage(); break;
                    case 1: goToPrevPage(); break;
                    case 2: goToNextPage(); break;
                    case 3: goToLastPage(); break;
                }
            });
        });

        // Initialize search functionality
        const searchInput = document.getElementById('searchInput');
        searchInput.addEventListener('input', function(e) {
            const searchTerm = e.target.value.toLowerCase().trim();
            
            if (!searchTerm) {
                students = [...originalStudents];
            } else {
                students = originalStudents.filter(student => {
                    // Check if first name exists and matches
                    const firstNameMatch = student.firstName && student.firstName.toLowerCase().includes(searchTerm);
                    
                    // Check if last name exists and matches
                    const lastNameMatch = student.lastName && student.lastName.toLowerCase().includes(searchTerm);
                    
                    // Check if email exists and matches
                    const emailMatch = student.email && student.email.toLowerCase().includes(searchTerm);
                    
                    // Check if full name exists and matches (first + space + last)
                    const fullName = (student.firstName && student.lastName) ? 
                        `${student.firstName} ${student.lastName}`.toLowerCase() : '';
                    const fullNameMatch = fullName && fullName.includes(searchTerm);
                    
                    // Return true if any match is found
                    return firstNameMatch || lastNameMatch || emailMatch || fullNameMatch;
                });
            }
            
            currentPage = 1; // Reset to first page when searching
            updateDisplay();
        });

        // Make sure originalStudents is properly initialized on page load
        window.addEventListener('DOMContentLoaded', function() {
            initializeStudentData();
        });

        // Make sure the search is cleared and reset when returning to the page
        window.addEventListener('pageshow', function() {
            const searchInput = document.getElementById('searchInput');
            if (searchInput) {
                searchInput.value = '';
                initializeStudentData();
                updateDisplay();
            }
        });

        // Helper function to initialize student data
        function initializeStudentData() {
            const urlParams = new URLSearchParams(window.location.search);
            const courseId = urlParams.get('courseId');
            
            if (!courseId) {
                console.error('Course ID not found');
                window.location.href = 'home.html';
                return;
            }
            
            const courses = auth.getUserCourses();
            const course = courses.find(c => c.id === parseInt(courseId));
            
            if (!course) {
                console.error('Course not found');
                window.location.href = 'home.html';
                return;
            }
            
            // Set original students
            currentCourse = course;
            students = [...currentCourse.students]; 
            originalStudents = [...students];
        }

        // Student Report Generation
        async function generateStudentReport(studentId) {
            try {
                // Convert studentId to string to match what's in the array
                studentId = String(studentId);
                
                // Get fresh course data
                const urlParams = new URLSearchParams(window.location.search);
                const courseId = urlParams.get('courseId');
                
                if (!courseId) {
                    throw new Error('Course ID not found');
                }
                
                const courses = auth.getUserCourses();
                const course = courses.find(c => c.id === parseInt(courseId));
                
                if (!course) {
                    throw new Error('Course not found');
                }

                // Find student using string comparison for consistency
                const student = course.students.find(s => String(s.id) === studentId);
                if (!student) {
                    throw new Error('Student not found');
                }

                // Remove existing modal if any
                const existingModal = document.getElementById('reportModal');
                if (existingModal) {
                    existingModal.remove();
                }

                // Create report modal
                const reportModal = document.createElement('div');
                reportModal.className = 'modal';
                reportModal.id = 'reportModal';
                reportModal.style.display = 'flex';
                
                // Get grades data
                const midtermGrade = student.grades?.midterm || 0;
                const finalGrade = student.grades?.final || 0;
                const assignmentGrades = student.grades?.assignments?.slice(0, 3).map(a => a.grade || 0) || [0, 0, 0];
                const homeworkGrades = student.grades?.assignments?.slice(3, 6).map(a => a.grade || 0) || [0, 0, 0];
                const totalGrade = student.grade || 0;
                
                reportModal.innerHTML = `
                    <div class="modal-content">
                        <div class="modal-header">
                            <h2>Student Progress Report</h2>
                            <button type="button" class="close-button" onclick="closeReportModal()">
                                <i class="material-icons-round">close</i>
                            </button>
                        </div>
                        <div class="report-content">
                            <div class="student-report-header">
                                <div class="student-avatar large">${student.firstName ? student.firstName[0] : ''}${student.lastName ? student.lastName[0] : ''}</div>
                                <div class="student-report-info">
                                    <h3>${student.firstName} ${student.lastName}</h3>
                                    <p>${student.email || ''}</p>
                                    <div class="status-badge ${student.active ? 'active' : 'inactive'}">${student.active ? 'Active' : 'Inactive'}</div>
                                </div>
                            </div>
                            
                            <div class="report-section">
                                <h4>Grade Summary</h4>
                                <div class="grades-overview">
                                    <div class="grade-item">
                                        <div class="grade-label">Midterm</div>
                                        <div class="grade-value">${midtermGrade}%</div>
                                    </div>
                                    <div class="grade-item">
                                        <div class="grade-label">Final</div>
                                        <div class="grade-value">${finalGrade}%</div>
                                    </div>
                                    <div class="grade-item">
                                        <div class="grade-label">Assignments Avg</div>
                                        <div class="grade-value">${Math.round(assignmentGrades.reduce((a, b) => a + b, 0) / assignmentGrades.length)}%</div>
                                    </div>
                                    <div class="grade-item">
                                        <div class="grade-label">Homework Avg</div>
                                        <div class="grade-value">${Math.round(homeworkGrades.reduce((a, b) => a + b, 0) / homeworkGrades.length)}%</div>
                                    </div>
                                    <div class="grade-item total">
                                        <div class="grade-label">Total Grade</div>
                                        <div class="grade-value">${totalGrade}%</div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="report-section">
                                <h4>Assignment Grades</h4>
                                <div class="grades-detail">
                                    <div class="grade-row">
                                        <div class="grade-name">Assignment 1</div>
                                        <div class="grade-bar-container">
                                            <div class="grade-bar" style="width: ${assignmentGrades[0]}%"></div>
                                        </div>
                                        <div class="grade-number">${assignmentGrades[0]}%</div>
                                    </div>
                                    <div class="grade-row">
                                        <div class="grade-name">Assignment 2</div>
                                        <div class="grade-bar-container">
                                            <div class="grade-bar" style="width: ${assignmentGrades[1]}%"></div>
                                        </div>
                                        <div class="grade-number">${assignmentGrades[1]}%</div>
                                    </div>
                                    <div class="grade-row">
                                        <div class="grade-name">Assignment 3</div>
                                        <div class="grade-bar-container">
                                            <div class="grade-bar" style="width: ${assignmentGrades[2]}%"></div>
                                        </div>
                                        <div class="grade-number">${assignmentGrades[2]}%</div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="report-section">
                                <h4>Homework Grades</h4>
                                <div class="grades-detail">
                                    <div class="grade-row">
                                        <div class="grade-name">Homework 1</div>
                                        <div class="grade-bar-container">
                                            <div class="grade-bar" style="width: ${homeworkGrades[0]}%"></div>
                                        </div>
                                        <div class="grade-number">${homeworkGrades[0]}%</div>
                                    </div>
                                    <div class="grade-row">
                                        <div class="grade-name">Homework 2</div>
                                        <div class="grade-bar-container">
                                            <div class="grade-bar" style="width: ${homeworkGrades[1]}%"></div>
                                        </div>
                                        <div class="grade-number">${homeworkGrades[1]}%</div>
                                    </div>
                                    <div class="grade-row">
                                        <div class="grade-name">Homework 3</div>
                                        <div class="grade-bar-container">
                                            <div class="grade-bar" style="width: ${homeworkGrades[2]}%"></div>
                                        </div>
                                        <div class="grade-number">${homeworkGrades[2]}%</div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="report-section ai-summary">
                                <h4>AI Progress Summary</h4>
                                <div class="ai-summary-content" id="aiSummaryContent">
                                    <div class="ai-summary-placeholder">
                                        <p>Click the button below to generate an AI-powered summary of this student's progress.</p>
                                        <button type="button" class="generate-ai-btn" onclick="requestAISummary('${studentId}')">Generate AI Summary</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(reportModal);
                
            } catch (error) {
                console.error('Error generating report:', error);
                alert('Failed to generate student report: ' + error.message);
            }
        }

        function closeReportModal() {
            const modal = document.getElementById('reportModal');
            if (modal) {
                modal.remove();
            }
        }

        async function requestAISummary(studentId) {
            try {
                // Show loading state
                const summaryContainer = document.getElementById('aiSummaryContent');
                if (!summaryContainer) return;
                
                summaryContainer.innerHTML = `
                    <div class="ai-summary-loading">
                        <div class="spinner"></div>
                        <p>Generating AI-powered progress summary...</p>
                    </div>
                `;
                
                // Get student and course data
                const urlParams = new URLSearchParams(window.location.search);
                const courseId = urlParams.get('courseId');
                
                if (!courseId) {
                    throw new Error('Course ID not found');
                }
                
                const courses = auth.getUserCourses();
                const course = courses.find(c => c.id === parseInt(courseId));
                
                if (!course) {
                    throw new Error('Course not found');
                }

                // Find student
                const student = course.students.find(s => String(s.id) === String(studentId));
                if (!student) {
                    throw new Error('Student not found');
                }
                
                // Generate AI summary
                const aiSummary = await generateAISummary(student, course);
                
                // Update the summary content
                if (summaryContainer) {
                    summaryContainer.innerHTML = aiSummary;
                }
            } catch (error) {
                console.error('Error fetching AI summary:', error);
                const summaryContainer = document.getElementById('aiSummaryContent');
                if (summaryContainer) {
                    summaryContainer.innerHTML = `
                        <div class="ai-summary-error">
                            <p>Could not generate AI summary. Please try again.</p>
                            <p class="error-details">${error.message}</p>
                            <button type="button" class="generate-ai-btn" onclick="requestAISummary('${studentId}')">Try Again</button>
                        </div>
                    `;
                }
            }
        }

        async function generateAISummary(student, course) {
            try {
                // Get performance metrics
                const totalGrade = student.grade || 0;
                const midtermGrade = student.grades?.midterm || 0;
                const finalGrade = student.grades?.final || 0;
                const assignmentGrades = student.grades?.assignments?.slice(0, 3).map(a => a.grade || 0) || [0, 0, 0];
                const homeworkGrades = student.grades?.assignments?.slice(3, 6).map(a => a.grade || 0) || [0, 0, 0];
                
                const avgAssignmentGrade = Math.round(assignmentGrades.reduce((a, b) => a + b, 0) / assignmentGrades.length);
                const avgHomeworkGrade = Math.round(homeworkGrades.reduce((a, b) => a + b, 0) / homeworkGrades.length);
                
                // Get comments if available
                const comments = Array.isArray(student.comments) ? student.comments : [];
                const commentTexts = comments.map(c => c.text);
                
                // Prepare the data to send to the API
                const apiInput = {
                    studentName: `${student.firstName} ${student.lastName}`,
                    courseName: course.name,
                    grades: {
                        total: totalGrade,
                        midterm: midtermGrade,
                        final: finalGrade,
                        assignments: assignmentGrades,
                        avgAssignment: avgAssignmentGrade,
                        homework: homeworkGrades,
                        avgHomework: avgHomeworkGrade
                    },
                    comments: commentTexts
                };
                
                // Call the API
                const response = await fetch(
                    'https://noggin.rea.gent/proper-wildcat-6710',
                    {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            Authorization: 'Bearer rg_v1_vg6ljwxv6opldh2p10d1nndr7itc76qlt19a_ngk',
                        },
                        body: JSON.stringify({
                            "input": JSON.stringify(apiInput),
                        }),
                    }
                ).then(response => response.text());
                
                // Check if we got a valid response
                if (!response) {
                    throw new Error('Empty response from AI service');
                }
                
                // Parse markdown to HTML
                const formattedResponse = parseMarkdown(response);
                return formattedResponse;
                
            } catch (error) {
                console.error('Error in AI summary generation:', error);
                throw error;
            }
        }

        // Simple markdown parser function
        function parseMarkdown(markdown) {
            if (!markdown) return '';
            
            // Convert headers (# Header)
            let html = markdown
                .replace(/^# (.*$)/gm, '<h1>$1</h1>')
                .replace(/^## (.*$)/gm, '<h2>$1</h2>')
                .replace(/^### (.*$)/gm, '<h3>$1</h3>')
                .replace(/^#### (.*$)/gm, '<h4>$1</h4>');
                
            // Convert bold (**text**)
            html = html.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            
            // Convert emphasis (*text*)
            html = html.replace(/\*(.*?)\*/g, '<em>$1</em>');
            
            // Convert line breaks
            html = html.replace(/\n\n/g, '</p><p>');
            html = html.replace(/\n/g, '<br>');
            
            // Convert lists
            html = html.replace(/^\s*[-*] (.*)$/gm, '<li>$1</li>');
            html = html.replace(/<li>(.*?)<\/li>/g, function(match) {
                return '<ul>' + match + '</ul>';
            }).replace(/<\/ul><ul>/g, '');
            
            // Handle horizontal rules (---)
            html = html.replace(/^---$/gm, '<hr>');
            
            // Wrap everything in paragraphs
            if (!html.startsWith('<h') && !html.startsWith('<ul') && !html.startsWith('<p>')) {
                html = '<p>' + html + '</p>';
            }
            
            return html;
        }

        // Initialize display
        updateDisplay();
    </script>
</body>
</html> 
